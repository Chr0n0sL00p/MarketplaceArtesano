{% extends 'base.html' %}

{% block title %}Chat con {{ otro_usuario.username }}{% endblock %}

{% block content %}
<div class="container my-4 d-flex flex-column" style="height: 80vh;">
    <style>
        .message-bubble {
            max-width: 75%;
        }

        .message-sent {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-received {
            background-color: white;
            border-bottom-left-radius: 4px;
        }
    </style>
    <!-- Header -->
    <div class="card shadow-sm border-0 flex-grow-1 overflow-hidden">
        <div class="card-header bg-white py-3 d-flex align-items-center border-bottom">
            <a href="{% url 'chat_inbox' %}" class="btn btn-light btn-sm rounded-circle me-3"><i
                    class="bi bi-arrow-left"></i></a>
            <div class="avatar-circle me-2 bg-primary text-white" style="width: 40px; height: 40px; font-size: 1.2rem;">
                {{ otro_usuario.username|make_list|first|upper }}
            </div>
            <div>
                <h5 class="mb-0 fw-bold">{{ otro_usuario.username }}</h5>
                <small class="text-success"><i class="bi bi-circle-fill" style="font-size: 8px;"></i> En lÃ­nea</small>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="card-body overflow-auto bg-light" id="chat-messages" style="flex: 1;">
            {% for mensaje in mensajes %}
            <div
                class="d-flex flex-column mb-3 {% if mensaje.remitente == user %}align-items-end{% else %}align-items-start{% endif %}">
                <div
                    class="p-3 rounded-4 shadow-sm message-bubble {% if mensaje.remitente == user %}message-sent{% else %}message-received{% endif %}">
                    <p class="mb-1">{{ mensaje.texto }}</p>
                </div>
                <small class="text-muted mt-1 mx-1" style="font-size: 0.75rem;">
                    {{ mensaje.fecha_envio|date:"H:i" }}
                    {% if mensaje.remitente == user %}
                    {% if mensaje.leido %}
                    <i class="bi bi-check2-all text-primary"></i>
                    {% else %}
                    <i class="bi bi-check2"></i>
                    {% endif %}
                    {% endif %}
                </small>
            </div>
            {% empty %}
            <div class="text-center py-5 text-muted">
                <p>Inicia la conversaciÃ³n con <strong>{{ otro_usuario.username }}</strong> ðŸ‘‹</p>
            </div>
            {% endfor %}
        </div>

        <!-- Input Area -->
        <div class="card-footer bg-white py-3">
            <form method="post" class="d-flex gap-2">
                {% csrf_token %}
                {{ form.texto }} <!-- The widget already has form-control class from forms.py -->
                <button type="submit"
                    class="btn btn-primary rounded-circle p-0 d-flex align-items-center justify-content-center"
                    style="width: 45px; height: 45px;">
                    <i class="bi bi-send-fill fs-5"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // Scroll to bottom
    const chatContainer = document.getElementById('chat-messages');
    chatContainer.scrollTop = chatContainer.scrollHeight;
</script>
{% endblock %}