<!doctype html>
{% load static %}
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Panel Admin - Marketplace Artesanos</title>

    <!-- Bootstrap -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.4/css/dataTables.bootstrap5.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.5/css/buttons.bootstrap5.css">

    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>

<body>

    <div class="container">
        <div class="alert alert-primary display-5 text-center my-5">
            Panel Administrador ‚Äì Marketplace de Artesanos üõçÔ∏è
        </div>

        <!-- Controles r√°pidos -->
        <div class="d-flex gap-2 mb-4">
            <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">Dashboard</a>
            <a href="{% url 'crear_tienda' %}" class="btn btn-primary">Crear Tienda</a>
            <a href="{% url 'crear_producto' %}" class="btn btn-success">Crear Producto</a>
        </div>

        <!-- Resumen de Estad√≠sticas -->
        <div class="row mb-5">
            <div class="col-md-3">
                <div class="card text-white bg-primary mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Total Usuarios</h5>
                        <p class="card-text fs-3">{{ total_usuarios }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Total Productos</h5>
                        <p class="card-text fs-3">{{ total_productos }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Total Tiendas</h5>
                        <p class="card-text fs-3">{{ total_tiendas }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-dark bg-warning mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Tiendas Pendientes</h5>
                        <p class="card-text fs-3">{{ tiendas_pendientes_count }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-danger mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Reportes Abuso</h5>
                        <p class="card-text fs-3">{{ reportes_pendientes_count }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-dark bg-light border-secondary mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Tickets Soporte</h5>
                        <p class="card-text fs-3">{{ tickets_pendientes_count }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-md-6">
                <h3>√öltimos Pedidos</h3>
                {% if ultimos_pedidos %}
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>ID Pedido</th>
                            <th>Producto</th>
                            <th>Comprador</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in ultimos_pedidos %}
                        <tr>
                            <td>{{ pedido.id }}</td>
                            <td>{{ pedido.producto.nombre }}</td>
                            <td>{{ pedido.comprador.username }}</td>
                            <td>{{ pedido.fecha_creacion|date:"Y-m-d H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No hay pedidos recientes.</p>
                {% endif %}
            </div>
            <div class="col-md-6">
                <h3>Nuevos Usuarios</h3>
                {% if ultimos_usuarios %}
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>ID Usuario</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Fecha Registro</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in ultimos_usuarios %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.date_joined|date:"Y-m-d H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No hay usuarios recientes.</p>
                {% endif %}
            </div>
        </div>

        <hr class="my-5">

        <!-- TABLA: Tiendas -->
        <h3 class="my-4">Tiendas</h3>
        <table id="tbtiendas" class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Artesano (usuario)</th>
                    <th>Ubicaci√≥n</th>
                    <th>Correo</th>
                    <th>Tel√©fono</th>
                    <th>Activa</th>
                    <th>Aprobada</th>
                    <th>Correo validado</th>
                    <th>Tel√©fono validado</th>
                    <th>Fecha creaci√≥n</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for tienda in tiendas %}
                <tr>
                    <td>{{ tienda.id }}</td>
                    <td>{{ tienda.nombre }}</td>
                    <td>{{ tienda.artesano.user.username }}</td>
                    <td>{{ tienda.ubicacion }}</td>
                    <td>{{ tienda.artesano.user.email }}</td>
                    <td>{{ tienda.artesano.telefono }}</td>
                    <td class="text-center">
                        {% if tienda.activa %}
                        <span class="badge bg-success">S√≠</span>
                        {% else %}
                        <span class="badge bg-secondary">No</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        {% if tienda.aprobada %}
                        <span class="badge bg-success">Aprobada</span>
                        {% else %}
                        <span class="badge bg-warning text-dark">Pendiente</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        {% if tienda.artesano.correo_validado %}
                        <span class="badge bg-success">S√≠</span>
                        {% else %}
                        <span class="badge bg-danger">No</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        {% if tienda.artesano.telefono_validado %}
                        <span class="badge bg-success">S√≠</span>
                        {% else %}
                        <span class="badge bg-danger">No</span>
                        {% endif %}
                    </td>
                    <td>{{ tienda.fecha_creacion|date:"Y-m-d H:i" }}</td>
                    <td class="text-center">
                        <!-- Activar / Desactivar -->
                        <a href="{% url 'cambiar_estado_tienda' tienda.id %}" class="text-primary me-2"
                            title="Activar/Desactivar">
                            {% if tienda.activa %}
                            <i class="bi bi-toggle-on" style="font-size:1.25rem"></i>
                            {% else %}
                            <i class="bi bi-toggle-off" style="font-size:1.25rem"></i>
                            {% endif %}
                        </a>

                        <!-- Aprobar tienda -->
                        <a href="{% url 'aprobar_tienda' tienda.id %}" class="text-success me-2" title="Aprobar tienda">
                            <i class="bi bi-check-circle-fill"></i>
                        </a>

                        <!-- Rechazar / marcar no aprobada -->
                        <a href="{% url 'rechazar_tienda' tienda.id %}" class="text-danger me-2"
                            title="Rechazar tienda">
                            <i class="bi bi-x-circle-fill"></i>
                        </a>

                        <!-- Validar correo -->
                        <a href="{% url 'validar_correo_tienda' tienda.id %}" class="text-success me-2"
                            title="Validar correo">
                            <i class="bi bi-envelope-check"></i>
                        </a>

                        <!-- Validar tel√©fono -->
                        <a href="{% url 'validar_telefono_tienda' tienda.id %}" class="text-warning me-2"
                            title="Validar tel√©fono">
                            <i class="bi bi-phone-check"></i>
                        </a>

                        <!-- Editar -->
                        <a href="{% url 'editar_tienda' tienda.id %}" class="text-warning me-2" title="Editar tienda">
                            <i class="bi bi-pencil-square"></i>
                        </a>

                        <!-- Eliminar -->
                        <a href="#" class="text-danger" data-bs-toggle="modal"
                            data-bs-target="#modalEliminarT{{ tienda.id }}" title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </a>
                    </td>
                </tr>

                <!-- Modal eliminar tienda -->
                <div class="modal fade" id="modalEliminarT{{ tienda.id }}" tabindex="-1"
                    aria-labelledby="modalEliminarLabelT{{ tienda.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalEliminarLabelT{{ tienda.id }}">
                                    <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Confirmar
                                    eliminaci√≥n
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body text-center">
                                <i class="bi bi-shop text-danger" style="font-size: 3rem;"></i>
                                <h5 class="mt-3">¬øEliminar la tienda <strong>{{ tienda.nombre }}</strong>?</h5>
                                <p class="text-muted">Esta acci√≥n eliminar√° la tienda y todos sus productos. No se puede
                                    deshacer.</p>
                            </div>
                            <div class="modal-footer justify-content-center border-0 pb-3">
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <a href="{% url 'eliminar_tienda' tienda.id %}" class="btn btn-danger">Eliminar</a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </tbody>
        </table>

        <hr class="my-5">

        <!-- TABLA: Rese√±as pendientes -->
        <h3 class="my-4">Rese√±as Pendientes</h3>
        <table id="tbresenas" class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Tienda</th>
                    <th>Usuario</th>
                    <th>Calificaci√≥n</th>
                    <th>Comentario</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for r in resenas %}
                <tr>
                    <td>{{ r.id }}</td>
                    <td>{{ r.tienda.nombre }}</td>
                    <td>{{ r.usuario.username }}</td>
                    <td>{{ r.calificacion }} ‚≠ê</td>
                    <td>{{ r.comentario|linebreaksbr }}</td>
                    <td>{{ r.fecha|date:"Y-m-d H:i" }}</td>
                    <td class="text-center">
                        {% if r.aprobada %}
                        <span class="badge bg-success">Aprobada</span>
                        {% else %}
                        <span class="badge bg-warning text-dark">Pendiente</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <!-- Aprobar rese√±a -->
                        <a href="{% url 'aprobar_resena' r.id %}" class="text-success me-3" title="Aprobar rese√±a">
                            <i class="bi bi-check-lg"></i>
                        </a>

                        <!-- Rechazar rese√±a -->
                        <a href="{% url 'rechazar_resena' r.id %}" class="text-danger me-3" title="Rechazar rese√±a">
                            <i class="bi bi-x-lg"></i>
                        </a>

                        <!-- Ver tienda -->
                        <a href="{% url 'ver_tienda' r.tienda.id %}" class="text-primary me-3" title="Ver tienda">
                            <i class="bi bi-shop"></i>
                        </a>

                        <!-- Modal ver comentario completo -->
                        <a href="#" class="text-secondary" data-bs-toggle="modal"
                            data-bs-target="#modalComentario{{ r.id }}" title="Ver comentario">
                            <i class="bi bi-chat-left-text"></i>
                        </a>
                    </td>
                </tr>

                <!-- Modal comentario -->
                <div class="modal fade" id="modalComentario{{ r.id }}" tabindex="-1"
                    aria-labelledby="modalComentarioLabel{{ r.id }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalComentarioLabel{{ r.id }}">
                                    Comentario de {{ r.usuario.username }}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body">
                                <p class="small text-muted">Tienda: <strong>{{ r.tienda.nombre }}</strong></p>
                                <p>{{ r.comentario|linebreaksbr }}</p>
                                <p class="text-end small text-muted">Fecha: {{ r.fecha|date:"Y-m-d H:i" }}</p>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                <a href="{% url 'aprobar_resena' r.id %}" class="btn btn-success">Aprobar</a>
                                <a href="{% url 'rechazar_resena' r.id %}" class="btn btn-danger">Rechazar</a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </tbody>
        </table>

        <!-- TABLA: Tickets de Soporte -->
        <h3 class="my-4">Tickets de Soporte (Abiertos)</h3>
        <table id="tbtickets" class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Usuario</th>
                    <th>Asunto</th>
                    <th>Estado</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for t in tickets %}
                <tr>
                    <td>{{ t.id }}</td>
                    <td>{{ t.usuario.username }}</td>
                    <td>{{ t.asunto }}</td>
                    <td><span class="badge bg-warning text-dark">{{ t.get_estado_display }}</span></td>
                    <td>{{ t.fecha_creacion|date:"Y-m-d H:i" }}</td>
                    <td>
                        <a href="{% url 'soporte' %}" class="btn btn-sm btn-primary">Ver</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- TABLA: Reportes de Abuso -->
        <h3 class="my-4">Reportes de Abuso</h3>
        <table id="tbreportes" class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Reportante</th>
                    <th>Motivo</th>
                    <th>Objetivo</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for r in reportes %}
                <tr>
                    <td>{{ r.id }}</td>
                    <td>{{ r.reportante.username }}</td>
                    <td>{{ r.motivo|truncatechars:50 }}</td>
                    <td>{{ r.content_object }}</td>
                    <td>{{ r.fecha_creacion|date:"Y-m-d H:i" }}</td>
                    <td>{{ r.get_estado_display }}</td>
                    <td>
                        <a href="#" class="btn btn-sm btn-danger">Revisar</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables -->
    <script src="https://cdn.datatables.net/2.3.4/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.3.4/js/dataTables.bootstrap5.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.5/js/dataTables.buttons.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.5/js/buttons.bootstrap5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.5/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.5/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.5/js/buttons.colVis.min.js"></script>

    <!-- Inicializaci√≥n DataTables -->
    <script>
        new DataTable('#tbtiendas', {
            responsive: true,
            dom: 'Bfrtip',
            buttons: [
                { extend: 'excelHtml5', text: '<i class="bi bi-file-earmark-excel"></i> Excel' },
                { extend: 'pdfHtml5', text: '<i class="bi bi-file-earmark-pdf"></i> PDF' },
                { extend: 'print', text: '<i class="bi bi-printer"></i> Imprimir' },
                { extend: 'colvis', text: '<i class="bi bi-layout-three-columns"></i> Columnas' }
            ],
            language: { url: 'https://cdn.datatables.net/plug-ins/2.3.4/i18n/es-MX.json' }
        });

        new DataTable('#tbresenas', {
            responsive: true,
            dom: 'Bfrtip',
            buttons: [
                { extend: 'excelHtml5', text: '<i class="bi bi-file-earmark-excel"></i> Excel' },
                { extend: 'pdfHtml5', text: '<i class="bi bi-file-earmark-pdf"></i> PDF' },
                { extend: 'print', text: '<i class="bi bi-printer"></i> Imprimir' },
                { extend: 'colvis', text: '<i class="bi bi-layout-three-columns"></i> Columnas' }
            ],
            language: { url: 'https://cdn.datatables.net/plug-ins/2.3.4/i18n/es-MX.json' }
        });

        new DataTable('#tbtickets', {
            responsive: true,
            dom: 'Bfrtip',
            buttons: ['excel', 'pdf', 'print', 'colvis'],
            language: { url: 'https://cdn.datatables.net/plug-ins/2.3.4/i18n/es-MX.json' }
        });

        new DataTable('#tbreportes', {
            responsive: true,
            dom: 'Bfrtip',
            buttons: ['excel', 'pdf', 'print', 'colvis'],
            language: { url: 'https://cdn.datatables.net/plug-ins/2.3.4/i18n/es-MX.json' }
        });
    </script>

</body>

</html>